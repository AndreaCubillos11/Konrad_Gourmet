<div class="agregar-plato-container">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <img src="assets/images/KonradGourmetLogo.png" alt="Logo">
        </div>
        <nav>
            <a routerLink="/home_jefe"><i class="fas fa-home"></i> Inicio</a>
            <a routerLink="/jefe_menu" class="active"><i class="fas fa-utensils"></i> Menú</a>
            <a routerLink="/solicitud_alimento"><i class="fas fa-clipboard-list"></i> Solicitudes</a>
            <a routerLink="/inventario"><i class="fa-solid fa-box"></i> Inventario</a>
        </nav>
    </aside>

    <!-- Contenido -->
    <div class="content">
        <!-- Header -->
        <div class="header">
            <input type="text" placeholder="Buscar..." class="search">
            <button class="alerta"><i class="fas fa-bell"></i> 1 Alerta: Stock bajo</button>
            <div class="user">
                <div class="user"><i class="fas fa-user-tie"></i> Jefe de Cocina</div>
                <button class="logout"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</button>
            </div>
        </div>

        <!-- Main -->
        <main class="main-content">
            <h1>Plato Nuevo</h1>

            <!-- FORMULARIO -->
            <form class="form-plato" [formGroup]="platoForm" (ngSubmit)="registrarPlato()">

                <!-- Nombre y Categoría del Plato -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del plato</label>
                        <input type="text" formControlName="nombre" placeholder="Ej: Bandeja Paisa">
                        <!-- NUEVO: Mensaje de error para nombre requerido -->
                        <div *ngIf="platoForm.get('nombre')?.invalid && platoForm.get('nombre')?.touched" class="error-message">
                            El nombre del plato es obligatorio.
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Categoría del Plato</label>
                        <select formControlName="id_categoria_plato">
                            <option value="">Seleccione una categoría</option>
                            <option *ngFor="let cp of categoriasPlato" [value]="cp.id_categoria">
                                {{ cp.nombre_categoria }}
                            </option>
                        </select>
                        <!-- NUEVO: Mensaje de error para categoría requerida -->
                        <div *ngIf="platoForm.get('id_categoria_plato')?.invalid && platoForm.get('id_categoria_plato')?.touched" class="error-message">
                            La categoría del plato es obligatoria.
                        </div>
                    </div>
                </div>

                <h3>Ingredientes del plato:</h3>

                <!-- NUEVO: Mensaje de error si no hay ingredientes -->
                <div *ngIf="ingredientes.invalid && ingredientes.touched && ingredientes.length === 0" class="error-message">
                    Debe agregar al menos un ingrediente.
                </div>

                <!-- Ingredientes dinámicos -->
                <div formArrayName="ingredientes">
                    <div *ngFor="let ing of ingredientes.controls; let i=index" [formGroupName]="i" class="form-row">

                        <!-- Categoría del Producto -->
                        <div class="form-group">
                            <label>Categoría del Producto</label>
                            <select formControlName="id_categoria_producto" (change)="consultarProductoPorCategoria(i)">
                                <option value="">Seleccione una categoría</option>
                                <option *ngFor="let cp of categoriasProducto" [value]="cp.id_categoria">
                                    {{ cp.nombre_categoria }}
                                </option>
                            </select>
                            <!-- NUEVO: Error para categoría de producto -->
                            <div *ngIf="ing.get('id_categoria_producto')?.invalid && ing.get('id_categoria_producto')?.touched" class="error-message">
                                La categoría del producto es obligatoria.
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Producto</label>
                            <select formControlName="id_producto">
                                <option value="">Seleccione un producto</option>
                                <option *ngFor="let p of productosPorIngrediente[i]" [value]="p.id_producto">
                                    {{ p.nombre }}
                                </option>
                            </select>
                            <!-- NUEVO: Error para producto -->
                            <div *ngIf="ing.get('id_producto')?.invalid && ing.get('id_producto')?.touched" class="error-message">
                                El producto es obligatorio.
                            </div>
                        </div>
                        <!-- Cantidad -->
                        <div class="form-group small">
                            <label>Cantidad</label>
                            <input type="number" formControlName="cantidad" placeholder="Ej: 200" min="0">
                            <!-- NUEVO: Error para cantidad -->
                            <div *ngIf="ing.get('cantidad')?.invalid && ing.get('cantidad')?.touched" class="error-message">
                                La cantidad es obligatoria y debe ser mayor a 0.
                            </div>
                        </div>

                        <!-- Unidad -->
                        <div class="form-group">
                            <label>Unidad</label>
                            <select formControlName="id_unidad">
                                <option value="">Seleccione unidad</option>
                                <option *ngFor="let u of unidades" [value]="u.id_unidad">
                                    {{ u.nombre_unidad }}
                                </option>
                            </select>
                            <!-- NUEVO: Error para unidad -->
                            <div *ngIf="ing.get('id_unidad')?.invalid && ing.get('id_unidad')?.touched" class="error-message">
                                La unidad es obligatoria.
                            </div>
                        </div>

                        <!-- Botón eliminar (solo si hay más de 1 ingrediente para evitar eliminar el único) -->
                        <button type="button" class="eliminar" (click)="eliminarIngrediente(i)" *ngIf="ingredientes.length > 1">
                            - Eliminar Ingrediente
                        </button>
                    </div>
                </div>

                <!-- Botón agregar ingrediente -->
                <div class="acciones-ingrediente">
                    <button type="button" class="btn-agregar" (click)="agregarIngrediente()">
                        <i class="fas fa-plus"></i> Agregar ingrediente
                    </button>
                </div>

                <!-- Precio -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Precio del plato</label>
                        <input type="number" formControlName="precio_venta" placeholder="Ej: 25000" min="0.01" step="0.01">
                        <!-- NUEVO: Mensaje de error para precio (requerido y >0) -->
                        <div *ngIf="platoForm.get('precio_venta')?.errors?.['required'] && platoForm.get('precio_venta')?.touched" class="error-message">
                            El precio es obligatorio.
                        </div>
                        <div *ngIf="platoForm.get('precio_venta')?.errors?.['minValue'] && platoForm.get('precio_venta')?.touched" class="error-message">
                            El precio debe ser mayor a 0.
                        </div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="form-botones">
                    <button type="submit" class="btn-guardar" [disabled]="platoForm.invalid">Guardar</button>
                    <button type="button" class="btn-cancelar" (click)="platoForm.reset(); ingredientes.clear(); productosPorIngrediente = []">
                        Cancelar
                    </button>
                </div>
            </form>
        </main>
    </div> <!-- Cierra .content -->

    <app-modal-notificacion [visible]="modalVisible" [tipo]="modalTipo" [titulo]="modalTitulo" [mensaje]="modalMensaje"
        (cerrar)="cerrarModal()">
    </app-modal-notificacion>
</div> <!-- Cierra .agregar-plato-container -->
